VITE_API_BASE_URL=http://localhost:8000/api

#VITE_API_BASE_URL=http://rosamexicano25be.on-forge.com/api
#VITE_API_BASE_URL=https://rosamexicano25be.on-forge.com/api



nginx CONFIG


ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;
ssl_dhparam /etc/nginx/dhparams.pem;

add_header X-Frame-Options "SAMEORIGIN";
add_header X-XSS-Protection "1; mode=block";
add_header X-Content-Type-Options "nosniff";

index index.html index.htm;

charset utf-8;

# FORGE CONFIG (DO NOT REMOVE!)
#include forge-conf/2917621/server/*;

location / {
    try_files $uri $uri/ =404;
}

location = /favicon.ico { access_log off; log_not_found off; }
location = /robots.txt  { access_log off; log_not_found off; }

access_log off;
error_log  /var/log/nginx/2917621-error.log error;

location ~ /\.(?!well-known).* {
    deny all;
}




    listen 443 ssl;
    listen [::]:443 ssl;
    http2 on;
    server_name rosamexicano.on-forge.com;

    ssl_certificate     /etc/nginx/ssl/rosamexicano.on-forge.com/xxxx.crt;
    ssl_certificate_key /etc/nginx/ssl/rosamexicano.on-forge.com/xxxx.key;

    root /home/forge/rosamexicano.on-forge.com/current/dist;
    index index.html;

    location ~* \.(?:js|mjs|css|map|png|jpg|jpeg|gif|ico|svg|webp|woff2?|ttf|eot)$ {
        try_files $uri =404;
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    location ~ \.php$ { return 404; }

    access_log /var/log/nginx/rosamexicano-frontend-access.log;
    error_log  /var/log/nginx/rosamexicano-frontend-error.log error;

    # ⚠️ Do NOT include other forge-conf files here that define another server/location
    # include forge-conf/2917547/server/*;   # ← keep commented
    # include forge-conf/2917547/site.conf;  # ← keep commented
}

server {
    listen 80;
    listen [::]:80;
    server_name rosamexicano25.on-forge.com;
    return 301 https://$host$request_uri;
}


#DEPLOYMENT SCRIPT
# Vue/Vite SPA deploy: build in-place in current working copy
set -eo pipefail

# ---- Adjust this if your site path is different ----
SITE_DIR="/home/forge/rosamexicano25.on-forge.com/current"
# e.g. for the other domain:
# SITE_DIR="/home/forge/rosamexicano25.on-forge.com/current"
# ----------------------------------------------------

echo "==> Deploying to $SITE_DIR"
cd "$SITE_DIR"

echo "==> Loading nvm if present"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" || true
[ -s "$HOME/.bash_profile" ] && . "$HOME/.bash_profile" || true
[ -f ".nvmrc" ] && nvm install && nvm use

echo "==> Node: $(node -v || echo 'not found'), npm: $(npm -v || echo 'not found')"

# Optional: ensure correct branch & latest commit
# git fetch --all --prune
# git checkout main
# git pull --ff-only origin main

# Optional: copy env for Vite build
if [ -f ".env.production" ] && [ ! -f ".env" ]; then
  echo "==> Copying .env.production to .env"
  cp -f .env.production .env
fi

echo "==> Installing dependencies"
if [ -f "pnpm-lock.yaml" ]; then
  npx -y pnpm@9 install --frozen-lockfile
  BUILD_CMD="npx -y pnpm@9 run build"
elif [ -f "yarn.lock" ]; then
  npx -y yarn@1.22.22 install --frozen-lockfile
  BUILD_CMD="npx -y yarn@1.22.22 build"
elif [ -f "package-lock.json" ]; then
  npm ci --no-audit --no-fund
  BUILD_CMD="npm run build"
else
  npm install --no-audit --no-fund
  BUILD_CMD="npm run build"
fi

echo "==> Building app"
export NODE_OPTIONS="--max-old-space-size=1024"
bash -lc "$BUILD_CMD"

echo "==> Verifying build output"
test -f "dist/index.html" || { echo "ERROR: dist/index.html not found"; exit 1; }

echo "==> Done"
